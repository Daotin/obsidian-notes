性能优化不是背八股文，不是看到慢就喊"用虚拟列表"、"上 CDN"。真正的优化是一个**发现问题 → 分析原因 → 对症下药**的过程。本文会带你建立一套系统的思维方式，让你面对性能问题时，知道该看哪里、怎么分析、如何决策。

## 第一步：设定目标 - 到底要优化到什么程度?

**无目标，不优化。**

在优化之前需要先明确：**我们要达到什么标准？**

以 Google 的 Core Web Vitals 为参考（这些指标直接对应用户体验）：

|用户感受|核心指标|及格线|优秀线|
|---|---|---|---|
|页面打开快|LCP (最大内容绘制)|< 4.0s|< 2.5s|
|交互响应快|INP (交互响应延迟)|< 500ms|< 200ms|
|页面不乱跳|CLS (布局偏移)|< 0.25|< 0.1|

**重要提醒**：不同业务对性能的要求不同。C 端面向大众的产品要求更严格，B 端内部系统可以适当放宽。根据实际情况设定你的目标。

## 第二步：测量现状 - 我们到底有多慢？

**工具选择**：

- **Lighthouse**（Chrome DevTools 自带）：在实验室环境跑分，数据稳定可复现
- **真实用户监控 (RUM)**：如 Sentry、使用PerformanceObserveable API 搭建监控系统，收集线上真实用户数据

记录下 LCP、INP、CLS 的数值。

如果是比较优秀的，其实就不必优化，不够优秀，才需要进入下一步。

## 第三步：工程化优化 - 先把"白送的分"拿到手

这一步的目标是：**用20%的成本，解决80%通用性问题**。

核心围绕：
- 代码压缩（包括js，css，图片，字体等）
- 代码分割
	- chunk分包
	- 路由懒加载
	- 组件按需加载
- UI组件库按需加载
- 可选：CDN 外部化大型库
- ...
完成后：再次运行 Lighthouse 测量，记录优化后的数据。

对比优化前后的数据，现在面临选择：

- 情况 A：指标已达到"优秀"线。**决策：停止优化，进入监控阶段**。你已经用 20% 的精力解决了 80% 的问题。对于绝大多数业务来说，这已经是一个完美的交付状态。
- 情况 B：核心指标仍未达标。**决策：启动定点优化**。接下来要深入业务层面，解决具体的性能瓶颈。

## 第四步：定点优化

定点优化主要围绕用户最关心的“页面打开慢”和“操作不流畅”这两个核心问题展开。

### 场景 1：首屏加载慢（LCP 大）

这时候我们可以打开devtools查看页面内容加载情况，如果有些资源加载很慢，考虑几个情况

- 网速慢？
	- TTFB慢？需要确认是网速慢还是后端响应慢。
	- 启用 HTTP/2，或者使用 CDN 加速静态资源
	- nginx缓存策略配置
- 还是包太大？
	- 分析：打包拆分有没问题？可否使用精简的npm包？可否使用外部库的cdn？
- 还是请求太多影响TCP连接数？
	- 合并小图标（雪碧图或 SVG Symbol）
- 用户体验优化手段
	- 骨架屏

### 场景 2：页面操作卡顿（INP 大）

重现卡顿：操作页面时打开 Performance 面板录制，找到卡顿发生的时刻，分析火焰图里最长的黄色（JS 执行）或紫色（渲染）块。
- 如果是黄色执行长，通常是某个函数执行太慢：长任务--考虑web worker或者放入`requestIdleCallback`时间切片执行）
- 如果是紫色太长，则是页面dom元素过多，可以考虑拆分组件，使用虚拟列表等技术。

### 场景 3：页面布局乱跳（CLS 大）

在 Lighthouse 报告中找到 CLS 贡献最大的元素。

- 字体加载导致文字跳动？
	- 字体使用woff2，压缩，精简字体集合等。
- 动态插入的广告/内容？
	- 为动态内容设置aspect-ratio（锁定宽高比例），预留 `min-height`空间等
	- 外部的脚本，使用async/defer，不阻塞页面的加载。

## 第六步：持续监控 - 不让性能倒退

性能不是一劳永逸的。随着业务迭代，新的性能瓶颈随时可能出现。

1. **建立性能预算**：在 CI/CD 流程中集成 **Lighthouse CI**。设定 LCP 不超过 2.5s、主包体积不超过 500KB 等预算。一旦有代码提交破坏了这个预算，流水线将失败告警，将性能问题扼杀在摇篮里。
2. **常态化 RUM**：持续关注线上真实用户数据的变化趋势，建立性能大盘和告警机制。当线上指标出现波动时，能第一时间发现并介入。


## 总结

性能优化的核心是**建立"目标→测量→通用优化→定点优化→持续监控"的闭环思维**。
先用 Core Web Vitals 设定明确目标，再通过 Lighthouse 测量现状；优先做工程化通用优化（代码压缩、分割、按需加载）拿到"性价比最高的80%收益"；如果仍未达标，则根据 Performance 火焰图和 Network 瀑布流进行定点分析——LCP 慢看资源加载链路，INP 大找长任务和渲染瓶颈，CLS 高定位布局跳动元素；最后通过 Lighthouse CI 和 前端监控 建立性能预算和实时监控，防止性能劣化。

**关键是数据驱动决策，避免凭感觉优化，用20%精力解决80%问题后再评估是否需要深入。**