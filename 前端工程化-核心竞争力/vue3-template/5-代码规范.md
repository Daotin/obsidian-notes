# 代码规范

## 开启 VSCode 插件推荐

新增 `.vscode/extensions.json` 文件

```json
{
  "recommendations": [
    "johnsoncodehk.volar",
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode"
  ]
}
```

## 项目工作区规范

新增 `.vscode/settings.json` 文件

```json
{
  // // eslint 保存格式化
  // "eslint.enable": true,
  // "eslint.run": "onType",
  // "eslint.options": {
  //   "extensions": [".js", ".ts", ".jsx", ".tsx", ".vue"]
  // },
  // // 编辑器保存格式化
  // "editor.codeActionsOnSave": {
  //   "source.fixAll": true,
  //   "source.fixAll.eslint": true
  // },
  // 保存到额时候用使用 prettier进行格式化
  "editor.formatOnSave": true,
  // // 默认使用prittier作为格式化工具
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "[javascript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[javascriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[vue]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  // 操作时作为单词分隔符的字符
  "editor.wordSeparators": "`~!@#%^&*()=+[{]}\\|;:'\",.<>/?",
  // 一个制表符等于的空格数
  "editor.tabSize": 2,
  // 行尾字符
  "files.eol": "\n"
}
```

## Prettier 配置

### 如果只使用 Prettier 不使用 eslint

> Prettier 主要是为了代码风格的规范或统一，例如单引号还是双引号，每行最大长度，等号左右空格，使用 tab 还是 空格等等

1、在 VSCode 中安装[Prettier](https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode)插件

2、新增`.prettierrc.js`文件

```js
module.exports = {
  // 超过多少字符后换行
  printWidth: 120,
  // 使用tab缩进还是空格
  useTabs: true,
  // 缩进
  tabWidth: 2,
  // 行末分号
  semi: false,
  // 单引号
  singleQuote: true,
  // 是否使用尾逗号
  trailingComma: 'all', // 对象或数组末尾加逗号
  // > 标签放在最后一行的末尾，而不是单独放在下一行
  jsxBracketSameLine: false,
  // (x) => {} 箭头函数参数只有一个时是否要有小括号。 alwaysz:总是带括号，avoid：省略括号
  arrowParens: 'avoid',
  // 仅在需要时为对象的键添加引号，如果至少一个键需要引号，则所有键都用引号
  quoteProps: 'consistent',
  // 在对象的大括号内添加空格
  bracketSpacing: true,
  // 将多行元素的结束标签放在最后一行的末尾，而不是单独占一行
  bracketSameLine: true,
  // 保持文本换行符的处理方式不变
  proseWrap: 'preserve',
  //html存在空格是不敏感的
  htmlWhitespaceSensitivity: 'ignore',
  // 在Vue文件中的<script>和<style>标签内缩进代码
  vueIndentScriptAndStyle: false,
  // 自动检测并使用文件中已有的行尾样式，作为行结束符
  endOfLine: 'auto',
  // 自动格式化嵌入的代码块
  embeddedLanguageFormatting: 'auto',
  // 每行单个HTML属性
  singleAttributePerLine: false,
};
```

3、新增`.prettierignore`文件

```
/dist/*
.local
.output.js
/node_modules/**

**/*.svg
**/*.sh

/public/*
```

#### idea 配置 Prettier

1、下载 prettier 插件
![](images/img-20240524160554.png)

2、配置

![](images/img-20240524160502.png)

3、代码的右键就可以手动格式化了，当然，可以设置保存时自动格式化。

![](images/img-20240524160505.png)

![](images/img-20240524160553.png)

### 如果使用了 eslint 规则校验

上面的配置均可忽略，包括不安装 vscode 的 Prettier 插件。

## ESLint 配置

> ESLint 主要是为了做代码检测，例如未使用的变量，未定义的引用，比较时使用 ===禁止不必要的括号等等===

### 如果只使用 Prettier 不使用 eslint

新增 `.eslintrc.cjs` 文件，并配置规则，关闭 prettier 的警告：

```js
/* eslint-env node */
require('@rushstack/eslint-patch/modern-module-resolution');

module.exports = {
  rules: {
    'prettier/prettier': 'off',
  },
};
```

### 如果使用了 eslint 规则校验

#### 1、安装eslint依赖

```
pnpm install eslint -D
```

> [!warning] vscode也需要安装[eslint插件](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint)。
#### 2、eslint初始化配置文件

通过 `npx eslint --init` 运行ESLint初始化向导，创建初始`eslint.config.mjs` 文件。

![](images/Pasted%20image%2020250305154724.png)

在选择完配置后，会自动根据你的选择，安装合适的依赖。所以，不需要，手动安装依赖。

#### 3、配置eslint规则

配置规则（最终以自己的项目为准进行修改）：

```js
// ESLint 新版 Flat Config 配置文件
// 采用 ESM 模块化方案，文件后缀为 .mjs

// 导入全局变量定义，包含预定义的浏览器、Node.js等环境的全局变量
import globals from 'globals'
// 导入 ESLint 官方的 JavaScript 规则插件
import pluginJs from '@eslint/js'
// 导入 TypeScript ESLint 插件，用于 TypeScript 代码的检查
import tseslint from 'typescript-eslint'
// 导入 Vue.js 的 ESLint 插件，用于 Vue 单文件组件的检查
import pluginVue from 'eslint-plugin-vue'
// 导入 Prettier ESLint 插件，用于代码格式化的集成
import pluginPrettier from 'eslint-plugin-prettier'
// import eslintPluginPrettierRecommended from 'eslint-plugin-prettier/recommended'

/** @type {import('eslint').Linter.Config[]} */
export default [
	// 匹配所有的 JS、TS 和 Vue 文件
	{ files: ['**/*.{js,mjs,cjs,ts,vue}'] },
	// 配置语言选项
	{
		languageOptions: {
			// 合并多个环境的全局变量
			globals: {
				...globals.browser, // 浏览器环境的全局变量
				...globals.node, // Node.js 环境的全局变量
				...globals.es2021, // ES2021 特性的全局变量
			},
		},
	},
	// 使用 ESLint 官方推荐的规则配置
	pluginJs.configs.recommended,
	// 使用 TypeScript ESLint 推荐的规则配置
	...tseslint.configs.recommended,
	// 使用 Vue 官方推荐的规则配置
	// essential 包含了最基本和重要的规则集,主要用于捕获常见错误
	// recommended 在 essential 的基础上增加了更多代码风格相关的规则
	...pluginVue.configs['flat/essential'],

	// 配置 Prettier 插件
	{
		plugins: {
			prettier: pluginPrettier,
		},
		rules: {
			// 启用prettier的规则
			// TODO: 其实可以不需要，因为在保存的时候会使用 .prettierrc.js 的配置进行格式化，跟这里的配置相同，所以不会出现冲突
			'prettier/prettier': [
				'warn',
				{
					printWidth: 120, // 每行代码最大长度
					semi: false, // 不使用分号
					singleQuote: true, // 使用单引号
					// tabWidth: 4, // 缩进使用4个空格
					useTabs: true, // 使用tab而不是空格
					trailingComma: 'es5', // 在 ES5 中有效的结尾逗号（对象，数组等）
					jsxBracketSameLine: false, // JSX 标签的 > 放在最后一行的末尾
					arrowParens: 'avoid', // 当箭头函数仅有一个参数时，省略参数括号
					endOfLine: 'auto', // 自动检测并保持与项目一致的换行符
				},
			],

			// 警告未使用的变量（TypeScript）
			'@typescript-eslint/no-unused-vars': 'warn',

			// 关闭未定义变量的检查
			'no-undef': 'off',

			// 关闭空块的检查
			'no-empty': 'off',

			// 禁止使用嵌套的三目运算符，提高代码可读性
			'no-nested-ternary': 'warn',

			// 注释规则配置
			// 要求注释符号 // 后必须跟随至少一个空格
			'spaced-comment': ['warn', 'always', { markers: ['/'] }],
			// 要求注释必须独立成行，放在代码上方
			'line-comment-position': ['warn', { position: 'above' }],
			// 多行注释必须使用 /** ... */ 风格
			'multiline-comment-style': ['warn', 'starred-block'],

			// TypeScript 命名规范配置
			'@typescript-eslint/naming-convention': [
				'warn',
				{
					// 接口名必须以 I 开头，使用大驼峰命名
					selector: 'interface',
					format: ['PascalCase'],
					custom: {
						regex: '^I[A-Z]',
						match: true,
					},
				},
				{
					// 类型别名必须以 T 开头，使用大驼峰命名
					selector: 'typeAlias',
					format: ['PascalCase'],
					custom: {
						regex: '^T[A-Z]',
						match: true,
					},
				},
				{
					// 类名必须使用大驼峰命名
					selector: 'class',
					format: ['PascalCase'],
				},
				{
					// 全局常量使用大驼峰或全大写命名
					selector: 'variable',
					modifiers: ['global', 'const'],
					format: ['PascalCase', 'UPPER_CASE'],
				},
				{
					// 普通变量使用小驼峰命名，特殊情况允许大写
					selector: 'variable',
					format: ['camelCase'],
				},
				{
					// 枚举类型必须以 Enum 开头，使用大驼峰命名
					selector: 'enum',
					format: ['PascalCase'],
					custom: {
						regex: '^Enum[A-Z]',
						match: true,
					},
				},
			],

			// 允许使用 any 类型
			'@typescript-eslint/no-explicit-any': 'warn',

			// 关闭分号检查
			semi: 'off',

			// 允许使用 this 的别名
			'@typescript-eslint/no-this-alias': 'off',

			// 关闭 debugger 语句的限制
			'no-debugger': 'error',

			// 关闭 Vue 模板中未使用变量的警告
			'vue/no-unused-vars': 'off',

			// 允许在模板中使用已声明的变量
			'vue/no-template-shadow': 'off',

			// 关闭 v-for 指令必须使用 key 的限制
			'vue/require-v-for-key': 'off',

			// 允许在 textarea 中使用模板语法
			'vue/no-textarea-mustache': 'off',

			// 允许使用 v-html 指令
			'vue/no-v-html': 'off',

			// 禁用组件名必须多个单词的规则
			'vue/multi-word-component-names': 'off',
		},
	},

	// 配置 Vue 文件的解析器选项
	// TIPS: 顺序很重要，vue的配置会覆盖上面rules的配置
	{
		files: ['**/*.vue'],
		languageOptions: {
			// 使用 Vue ESLint 解析器作为主解析器
			parser: pluginVue.parser,
			parserOptions: {
				// 使用 TypeScript 解析器解析 <script> 块
				parser: tseslint.parser,
				// 使用最新的 ECMAScript 版本
				ecmaVersion: 'latest',
				// 使用 ESM 模块化方案
				sourceType: 'module',
			},
		},
		rules: {
			// 在 Vue 文件中放宽命名规则限制
			'@typescript-eslint/naming-convention': [
				'warn',
				{
					// 变量和函数名使用小驼峰命名
					selector: ['variable', 'function'],
					format: ['camelCase'],
				},
			],
		},
	},
	/**
   * - 注册prettier插件
    - 开启prettier/prettier规则
    - 关闭所有可能与prettier冲突的ESLint规则
    如果完全接受prettier的推荐配置，使用这方式更简洁
   */
	// eslintPluginPrettierRecommended,
]


```

#### 4、配置lint script

在 `package.json` 中添加下面指令，用来检测和修复代码的 eslint 错误：

```json
{
  "scripts": {
    "lint": "eslint --cache --ext .vue,.ts,.tsx,.js,.jsx,.json --max-warnings 0 src/",
    "lint:fix": "eslint --cache --ext .vue,.ts,.tsx,.js,.jsx,.json --max-warnings 0 src/ --fix"
  }
}
```

> - 使用 --cache 提升检查速度：它启用了缓存功能,这样可以只检查修改过的文件,提高检查速度
> - 设置 --max-warnings 0 确保严格的代码质量：设置了警告数量上限为0,意味着任何警告都会导致命令失败
> - 使用 --ignore-path .gitignore 复用 git 忽略配置
> - --fix: 参数表示自动修复可以修复的问题
> - 使用 --ext 方式指定文件类型,更清晰直观


> [!warning] 
> 需要注意的是，`eslint --fix` 不能修复所有的问题。它主要用于自动修复那些可以安全地更改的问题，例如缩进、空格、换行符、引号类型等。这些问题通常与代码格式有关，而不涉及代码逻辑。
> 
> 对于一些可能需要更复杂的逻辑或代码结构调整的问题，如注释位置、变量未使用、变量未声明等，eslint 通常无法自动修复。这是因为自动修复这些问题可能会引入新的错误或改变程序的行为，所以需要开发者手动检查并修复这些问题。


或者使用`ctrl+shift+p`打开 vscode 控制台，通过`ESLint: Fix all auto-fixable Problems` 进行修复当前代码。

VSCode 的 ESLint 插件中的 `ESLint: Fix all auto-fixable Problems` 命令底层调用的就是 `eslint --fix` 指令。

当你在 VSCode 中使用这个命令时，插件会针对当前打开的文件运行 eslint --fix，并尝试自动修复所有可以修复的问题。这与在命令行中使用 npm run lint:fix 类似，只是作用范围限于当前打开的文件，而不是整个项目。


#### 5、新增`.eslintignore`

示例配置：
```
# 构建产物和依赖
dist/
dist-ssr/
build/
node_modules/
coverage/

# 日志文件
logs/
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

# 自动生成的文件
auto-imports.d.ts
components.d.ts
*.local
*.d.ts
!src/**/*.d.ts

# 编辑器和IDE
.vscode/*
!.vscode/extensions.json
.idea
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

# 测试相关
/cypress/videos/
/cypress/screenshots/

# 配置文件
*.config.js
vite.config.ts
vitest.config.ts
eslint.config.mjs

# 文档和资源
*.md
/public
/docs
.husky
/bin
Dockerfile

# 其他系统文件
.DS_Store
.local

# 压缩和临时文件
*.min.js
*.temp
```


## Stylelint配置
目前，ESLint 可以通过 `@eslint/css` 插件支持了 [CSS 文件的 linting](https://eslint.org/blog/2025/02/eslint-css-support/)，但目前尚未扩展到 Less 和 SCSS 文件。

因此，如果需要对 Less 和 SCSS 进行 linting，还是需要使用 [Stylelint](https://stylelint.bootcss.com/index.html)。

Stylelint 是一个强大的 CSS 代码检查工具，支持 Less 和 SCSS 的语法，并可以通过安装相应的插件和配置来实现对这些文件的 linting。

在本项目中，我们使用 Stylelint 来检查：

- `.less` 文件中的样式代码
- `.vue` 文件中的 `<style>` 部分（支持 Less 语法）

通过 Stylelint，我们可以：

- 捕获样式中的错误和风格问题
- 确保团队样式代码的一致性
- 自动修复部分样式问题
- 与编辑器集成，实现实时提示

### 安装步骤

#### 1. 安装必要的依赖

```bash
pnpm add -D stylelint stylelint-less stylelint-order postcss-html postcss-less
```

这些依赖的作用：

- `stylelint`: 核心检查工具
- `stylelint-less`: Less 语法支持
- `stylelint-order`: CSS 属性排序插件
- `postcss-html`: 解析 Vue 文件中的样式
- `postcss-less`: 解析 Less 语法

#### 2. 安装 VS Code 插件（可选但推荐）

为了在编辑器中获得实时反馈，建议安装 VS Code 的 Stylelint 插件：

1. 打开 VS Code
2. 转到扩展视图 (Ctrl+Shift+X)
3. 搜索 "Stylelint"
4. 安装由 Stylelint 提供的插件

#### 3. 创建配置文件

在项目根目录创建 `.stylelintrc.js` 文件：

```js
module.exports = {
	plugins: ['stylelint-less', 'stylelint-order'],
	overrides: [
		{
			files: ['**/*.vue'],
			customSyntax: 'postcss-html',
		},
		{
			files: ['**/*.less'],
			customSyntax: 'postcss-less',
		},
	],
	rules: {
		// 基础规则
		'color-no-invalid-hex': true,

		// 其他规则配置...
	},
	ignoreFiles: ['**/*.js', '**/*.jsx', '**/*.tsx', '**/*.ts', 'dist/**/*', 'node_modules/**/*'],
}
```

#### 4. 在 package.json 中添加脚本

```json
"scripts": {
  "stylelint": "stylelint \"src/**/*.{css,less,vue}\" --cache",
  "stylelint:fix": "stylelint \"src/**/*.{css,less,vue}\" --cache --fix"
}
```

#### 5. 配置 VS Code 设置（可选）

在项目根目录创建或修改 `.vscode/settings.json` 文件：

```json
{
	"stylelint.validate": ["css", "less", "vue"],
	"editor.codeActionsOnSave": {
		"source.fixAll.stylelint": true
	},
	"css.validate": false,
	"less.validate": false
}
```

#### 6. 添加 .stylelintcache 到 .gitignore

```
# Stylelint cache
.stylelintcache
```

### 配置文件详解

`.stylelintrc.js` 文件是 Stylelint 的核心配置，下面详细解释各部分：

```js
module.exports = {
	// 插件配置
	plugins: [
		'stylelint-less', // 支持 Less 语法
		'stylelint-order', // 支持 CSS 属性排序
	],

	// 针对不同文件类型的特定配置
	overrides: [
		{
			// Vue 文件配置
			files: ['**/*.vue'],
			customSyntax: 'postcss-html', // 使用 postcss-html 解析 Vue 文件中的样式
		},
		{
			// Less 文件配置
			files: ['**/*.less'],
			customSyntax: 'postcss-less', // 使用 postcss-less 解析 Less 文件
		},
	],

	// 规则配置
	rules: {
		// 基础规则
		'color-no-invalid-hex': true, // 禁止使用无效的十六进制颜色

		// Vue 特定规则
		'selector-pseudo-class-no-unknown': [
			true,
			{
				// Vue 中的特殊伪类
				ignorePseudoClasses: ['deep', 'global'],
			},
		],
		'selector-pseudo-element-no-unknown': [
			true,
			{
				// Vue 中的特殊伪元素
				ignorePseudoElements: ['v-deep', 'v-global', 'v-slotted'],
			},
		],

		// Less/SCSS 支持
		'at-rule-no-unknown': [
			true,
			{
				ignoreAtRules: [
					'tailwind',
					'apply',
					'variants',
					'responsive',
					'screen',
					'function',
					'if',
					'each',
					'include',
					'mixin',
					'import',
				],
			},
		],

		// 其他规则...
	},

	// 忽略文件
	ignoreFiles: ['**/*.js', '**/*.jsx', '**/*.tsx', '**/*.ts', 'dist/**/*', 'node_modules/**/*'],
}
```

### VS Code 集成

通过 VS Code 的 Stylelint 插件和项目配置，你可以获得以下功能：

1. **实时提示**：编辑样式代码时，错误和警告会直接在编辑器中显示
2. **保存时自动修复**：配置了 `editor.codeActionsOnSave` 后，保存文件时会自动修复可修复的问题
3. **禁用内置检查**：设置 `css.validate` 和 `less.validate` 为 `false` 可以避免 VS Code 内置检查与 Stylelint 的冲突

### 使用方法

#### 命令行检查

要检查项目中的样式文件，运行：

```bash
pnpm stylelint
```

#### 自动修复

要自动修复可修复的问题，运行：

```bash
pnpm stylelint:fix
```

#### 编辑器中使用

安装并配置好 VS Code Stylelint 插件后：

1. 错误和警告会在编辑器中以波浪线标记
2. 鼠标悬停在标记上可以查看详细信息
3. 保存文件时会自动修复可修复的问题（如已配置）
4. 可以使用快速修复功能（Ctrl+.）来修复单个问题

### 常见问题排查

#### 1. Vue 文件中的样式无法识别

确保：

- 安装了 `postcss-html` 依赖
- 配置了正确的 `overrides` 设置
- 检查 Vue 文件中的 `<style>` 标签是否正确

#### 2. Less 语法无法识别

确保：

- 安装了 `postcss-less` 和 `stylelint-less` 依赖
- 配置了正确的 `overrides` 设置
- 检查 Less 文件是否有语法错误

#### 3. 某些规则过于严格

可以通过修改 `.stylelintrc.js` 文件中的 `rules` 部分来禁用或自定义特定规则：

```js
rules: {
  // 禁用规则
  'rule-name': null,

  // 自定义规则
  'another-rule': [true, { /* 选项 */ }]
}
```

#### 4. 自动修复未生效

检查：

- 运行的是否是 `stylelint:fix` 命令
- VS Code 设置中 `editor.codeActionsOnSave` 是否正确配置
- 问题是否属于可自动修复的类型（并非所有问题都可自动修复）

---

如有更多问题，请参考 [Stylelint 官方文档](https://stylelint.io/)。
